#!/system/bin/sh
ARCH=$(uname -m) ; BASH=$(basename "$(readlink -f "$0")") ; SPATH=$(dirname "$(readlink -f "$0")")
export PATH="$(magisk --path)/.magisk/busybox:/data/adb/ksu/bin:$PATH:/data/data/com.termux/files/usr/bin"
source /data/adb/modules/${BASH}/config/${BASH}.ini
time=$(date +"[%Y-%m-%d %H:%M:%S %Z]")
dns_port=$(grep "listen" ${config_path}/clash | awk -F ':' '{print $3}')
tun_device=$(grep "device" ${config_path}/clash | awk -F ': ' '{print $2}')
redir_port=$(grep "redir-port" ${config_path}/clash | awk -F ': ' '{print $2}')
tproxy_port=$(grep "tproxy-port" ${config_path}/clash | awk -F ': ' '{print $2}')
fake_ip_range=$(grep "fake-ip-range" ${config_path}/clash | awk -F ': ' '{print $2}')
battery_level="$(echo "$(dumpsys battery)" | egrep 'level: ' | sed -n 's/.*level: //g;$p')"
intranet=(0.0.0.0/8 10.0.0.0/8 100.64.0.0/10 127.0.0.0/8 169.254.0.0/16 192.0.0.0/24 192.0.2.0/24 192.88.99.0/24 192.168.0.0/16 198.51.100.0/24 203.0.113.0/24 224.0.0.0/4 240.0.0.0/4 255.255.255.255/32) && intranet[${#intranet[@]}]=$(ip address | grep -w inet | grep -v 127 | awk '{print $2}')
intranet6=(::/128 ::1/128 ::ffff:0:0/96 100::/64 64:ff9b::/96 2001::/32 2001:10::/28 2001:20::/28 2001:db8::/32 2002::/16 fe80::/10 ff00::/8) && intranet6[${#intranet6[@]}]=$(ip address | grep -w inet6 | grep -v ::1 | grep -v fe80 | awk '{print $2}')
bin_pid=$(pidof ${bin_name} 2>/dev/null) && kernel_user=$(stat -c %U /proc/${bin_pid}) && kernel_group=$(stat -c %G /proc/${bin_pid})

function notification(){

[ -t 1 ] && echo -e "\033[1;36m${time} - ${BASH}: $1\033[0m" || echo "${time} - ${BASH}: $1" ; echo "${time} - ${BASH}: $1" >>${Services} ; sed -i "s/version=.*/version=$(date +"%Z (%m-%d %H:%M:%S)")/g" ${MODPATH}/module.prop > /dev/null 2>&1 ; sed -i "s/description=.*/description=[ $1 ] Build a local transit server on the device to realize a series of functions such as routing and terminal./g" ${MODPATH}/module.prop > /dev/null 2>&1 ; su -lp 2000 -c "cmd notification post -S messaging --conversation '${ARCH}' --message '${BASH}':'$1' 'Tag' '$(echo $RANDOM)' " > /dev/null 2>&1

}

start_bin() {

  if [ -f "${SPATH}/${bin_name}" ] ; then
    mkdir -p ${DATADIR}
    ln -sf ${MODPATH} ${DATADIR}
    chown 0:3005 ${SPATH}/${bin_name}
    chmod 6110 ${SPATH}/${bin_name}
    rm ${DATADIR}/${ARCH}.log > /dev/null 2>&1
    ln -sf ${config_path}/${bin_name} ${template_file}
    if [ "${iptables_status}" = "Tun" ] ; then
      mkdir -p /dev/net
      [ ! -L /dev/net/tun ] && ln -sf /dev/tun /dev/net/tun
    fi
  else
    notification "NOT Found “${bin_name}” Kernel"
    exit 1
  fi

  if [ "${bin_name}" = "clash" ] ; then
    if [ -f ${template_file} ] ; then
      if $(${SPATH}/${bin_name} -d ${DATADIR} -t -f ${template_file} > /dev/null) ; then
        ulimit -SHn 1000000
        nohup setuidgid 0:3005 ${SPATH}/clash -d ${DATADIR} -f ${template_file} > /dev/null 2>&1 &
      else
        ${SPATH}/${bin_name} -d ${DATADIR} -t -f ${template_file} > ${DATADIR}/${ARCH}.log 2>&1 &
        notification "“${bin_name}” incorrect configuration"
        exit 1
      fi
    else
      notification "NOT Found “${bin_name}” run file"
      exit 1
    fi
  elif [ "${bin_name}" = "sing-box" ] ; then
    if [ -f ${template_file} ] ; then
      if $(${SPATH}/${bin_name} check -D ${DATADIR} -c box.json > /dev/null) ; then
        ulimit -SHn 1000000
        nohup setuidgid 0:3005 ${SPATH}/sing-box run -D ${DATADIR} -c box.json > /dev/null 2>&1 &
      else
        ${SPATH}/${bin_name} check -D ${DATADIR} -c box.json > ${DATADIR}/${ARCH}.log 2>&1 &
        notification "“${bin_name}” incorrect configuration"
        exit 1
      fi
    else
      notification "NOT Found “${bin_name}” run file"
      exit 1
    fi
  else
    notification "The “${bin_name}” currently not supported"
    exit1
  fi

}

dns_server() {

  if [ -f "${SPATH}/mosdns" ] ; then
    chown 0:1051 ${SPATH}/mosdns
    chmod 110 ${SPATH}/mosdns
    ln -sf ${config_path}/dns ${DATADIR}/config.yaml
  else
    notification "NOT Found “mosdns” Kernel"
    exit 1
  fi

  if [ "$1" = "true" ] ; then
    ulimit -SHn 1000000
    nohup setuidgid 0:1051 ${SPATH}/mosdns start -d ${DATADIR} > /dev/null 2>&1 &
  elif [ "$1" = "false" ] ; then
    if pid=$(pidof mosdns 2>/dev/null); then
      kill -15 ${pid}
      rm ${DATADIR}/config.yaml > /dev/null 2>&1
      rm ${DATADIR}/dns.log > /dev/null 2>&1
    fi
  fi

}

nas_server() {

  if [ -f "${SPATH}/Alist" ] ; then
    mkdir -p ${mount_path}
    chown 0:1009 ${SPATH}/Alist
    chmod 7770 ${SPATH}/Alist
    ln -sf ${config_path}/mount ${mount_path}/config.json
  else
    notification "NOT Found “Alist” Kernel"
    exit 1
  fi

  if [ "$1" = "true" ] ; then
    ulimit -SHn 1000000
    nohup setuidgid 0:1000 ${SPATH}/Alist server --data ${mount_path} > /dev/null 2>&1 &
  elif [ "$1" = "false" ] ; then
    if pid=$(pidof Alist 2>/dev/null); then
      kill -15 ${pid}
      rm ${DATADIR}/mount.log > /dev/null 2>&1
      rm ${mount_path}/config.json > /dev/null 2>&1
    fi
  fi

}

upkernel() {

  if [ -f "${DATADIR}/${bin_name}" ] ; then
    ${SPATH}/${BASH} upx ${bin_name} > /dev/null 2>&1
    cp ${DATADIR}/${bin_name} ${SPATH}/${bin_name}
    rm ${DATADIR}/${bin_name}
    notification "“${bin_name}” update success"
  else
    if [ "${bin_name}" = "clash" ] ; then
      wget -q $(curl -s https://api.github.com/repos/clashCubeX/Clash.clash/releases/tags/Prerelease-Alpha | grep "download/Prerelease-Alpha/clash.meta-android-arm64-cgo-alpha" | cut -d : -f 2,3 | tr -d \") -O ${DATADIR}/clash.gz && gzip -d ${DATADIR}/clash.gz && chmod 0755 ${DATADIR}/clash && ${DATADIR}/clash -v
    else
      notification 'Only supports Clash clash'
    fi
  fi

  if [ -f "${DATADIR}/${bin_name}" ] ; then
    ${SPATH}/${BASH} upx ${bin_name} > /dev/null 2>&1
    cp ${DATADIR}/${bin_name} ${SPATH}/${bin_name}
    rm ${DATADIR}/${bin_name}
    notification "“${bin_name}” update success"
  else
    rm ${DATADIR}/clash.gz
    notification "Update “Clash clash” does not exist"
  fi

}

updateFile() {

  mv -f $1 $1.bak
  echo "curl -L -A 'clash' $2 -o $1"
  wget --no-check-certificate -U clash -O $1 $2 2>&1

  sleep 1

  if [ -f "$1" ]; then
    rm -rf $1.bak
    notification "success：$1"
  else
    mv $1.bak $1
    notification "error：$1"
    return 1
  fi

}

script() {

  if [ "${script_run}" = "true" ] ; then

    function vmlog() {
      if test $(ls -l $1 | awk '{ print $5 }') -gt $((1024 * 6)); then
        echo "${time} - ${BASH} mount path: '${SPATH}' ; ARCH: '${ARCH}'" > $1 ; sync && echo 3 > /proc/sys/vm/drop_caches | echo 1 > /proc/sys/vm/compact_memory
        notification "reload：$1"
      fi
    }

    vmlog "${Services}" ; vmlog "${DATADIR}/dns.log" ; vmlog "${DATADIR}/kernel.log" ; vmlog "${DATADIR}/mount.log"

    if [ "${Charge_control}" = "true" ] ; then
      if [ "${battery_level}" = "96" ] && [ "$(cat ${battery_path})" = "0" ] ; then
        echo 1 > ${battery_path} && echo "${time} - ${BASH}: Trigger quantitative stop charging" >> ${Services}
      elif [ "${battery_level}" = "86" ] && [ "$(cat ${battery_path})" = "1" ] ; then
        echo 0 > ${battery_path} && echo "${time} - ${BASH}: End quantitative stop charging" >> ${Services}
      fi
    elif [ "${Charge_control}" = "false" ] ; then
      if [ "${battery_level}" != "100" ] && [ "$(cat ${battery_path})" = "1" ] ; then
        echo 0 > ${battery_path} && echo "${time} - ${BASH}: End quantitative stop charging" >> ${Services}
      fi
    fi

  fi

}

updata_server() {

  if [ ${updateYacd} == "true" ]; then
    updateFile ${Yacd} ${Yacd_url}
    if [ -f "${Yacd}" ] ; then
      unzip -d ${DATADIR}/ ${Yacd}
      if [ -f "${DATADIR}/Yacd-meta-gh-pages/Twemoji_Mozilla.ttf" ] ; then
        rm -rf ${Dashboard} && mv ${DATADIR}/Yacd-meta-gh-pages ${Dashboard} && rm ${Yacd}
      else
        rm ${Yacd} ; rm -rf ${DATADIR}/Yacd-meta-gh-pages
        notification "error：${Yacd}"
      fi
    fi
  fi

  if [ ${updateMmdb} == "true" ]; then
    updateFile ${Mmdb} ${Mmdb_url}
  fi

  if [ ${updateGeoSite} == "true" ]; then
    updateFile ${GeoSite_file} ${GeoSite_url}
  fi

  if [ ${updateGeoIP} == "true" ]; then
    updateFile ${GeoIP_file} ${GeoIP_url}
  fi

  rm ${MODPATH}/updata

}

start_redirect() {

  ${iptables} -t nat -N AURORA_EXTERNAL
  ${iptables} -t nat -F AURORA_EXTERNAL
  ${iptables} -t nat -N AURORA_LOCAL
  ${iptables} -t nat -F AURORA_LOCAL

  if [ "${bin_name}" = "clash" ] ; then
    ${iptables} -t nat -A AURORA_EXTERNAL -p udp --dport 53 -j REDIRECT --to-ports ${dns_port}
    ${iptables} -t nat -A AURORA_LOCAL -p udp --dport 53 -j REDIRECT --to-ports ${dns_port}
    ${iptables} -t nat -A AURORA_EXTERNAL -d ${fake_ip_range} -p icmp -j DNAT --to-destination 127.0.0.1
    ${iptables} -t nat -A AURORA_LOCAL -d ${fake_ip_range} -p icmp -j DNAT --to-destination 127.0.0.1
  fi

  for subnet in ${intranet[@]} ; do
    ${iptables} -t nat -A AURORA_EXTERNAL -d ${subnet} -j RETURN
    ${iptables} -t nat -A AURORA_LOCAL -d ${subnet} -j RETURN
  done

  ${iptables} -t nat -A AURORA_EXTERNAL -p tcp -i lo -j REDIRECT --to-ports ${redir_port}

  if [ "${ap_list}" != "" ] ; then
    for ap in ${ap_list[@]} ; do
      ${iptables} -t nat -A AURORA_EXTERNAL -p tcp -i ${ap} -j REDIRECT --to-ports ${redir_port}
    done

  fi

  ${iptables} -t nat -I PREROUTING -j AURORA_EXTERNAL


  ${iptables} -t nat -I AURORA_LOCAL -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -j RETURN

  ${iptables} -t nat -A AURORA_LOCAL -p tcp -j REDIRECT --to-ports ${redir_port}

  ${iptables} -t nat -I OUTPUT -j AURORA_LOCAL

  ${iptables} -A OUTPUT -d 127.0.0.1 -p tcp -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -m tcp --dport ${redir_port} -j REJECT

}

stop_redirect() {

  ${iptables} -t nat -D PREROUTING -j AURORA_EXTERNAL

  ${iptables} -t nat -D OUTPUT -j AURORA_LOCAL

  ${iptables} -D OUTPUT -d 127.0.0.1 -p tcp -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -m tcp --dport ${redir_port} -j REJECT
  ${iptables} -D OUTPUT -d 127.0.0.1 -p tcp -m owner --uid-owner 0 --gid-owner 3005 -m tcp --dport ${redir_port} -j REJECT

  ${iptables} -t nat -F AURORA_EXTERNAL
  ${iptables} -t nat -X AURORA_EXTERNAL
  ${iptables} -t nat -F AURORA_LOCAL
  ${iptables} -t nat -X AURORA_LOCAL

}

iPV6Network() {

  if [ "$1" = "false" ] ; then
    if [ "${apn_ipv6}" = "true" ] ; then
      notification "iPV6Network: $1"
      echo 0 > /proc/sys/net/ipv6/conf/all/accept_ra
      echo 0 > /proc/sys/net/ipv6/conf/wlan0/accept_ra
      echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6
      echo 1 > /proc/sys/net/ipv6/conf/default/disable_ipv6
      echo 1 > /proc/sys/net/ipv6/conf/wlan0/disable_ipv6
    fi
  elif [ "$1" = "true" ] ; then
    notification "iPV6Network: $1"
    echo 1 > /proc/sys/net/ipv6/conf/all/accept_ra
    echo 1 > /proc/sys/net/ipv6/conf/wlan0/accept_ra
    echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6
    echo 0 > /proc/sys/net/ipv6/conf/default/disable_ipv6
    echo 0 > /proc/sys/net/ipv6/conf/wlan0/disable_ipv6
  fi

}

forward() {

  iptables -w 100 $1 FORWARD -o ${tun_device} -j ACCEPT
  iptables -w 100 $1 FORWARD -i ${tun_device} -j ACCEPT
  ip6tables -w 100 $1 FORWARD -o ${tun_device} -j ACCEPT
  ip6tables -w 100 $1 FORWARD -i ${tun_device} -j ACCEPT

}

start_tproxy() {

  if [ "${iptables}" = "ip6tables -w 100" ] ; then
    ip -6 rule add fwmark 222 table 222 pref 222
    ip -6 route add local default dev lo table 222
  else
    ip rule add fwmark 222 table 222 pref 222
    ip route add local default dev lo table 222
  fi

  ${iptables} -t mangle -N AURORA_EXTERNAL
  ${iptables} -t mangle -F AURORA_EXTERNAL

  if [ "${bin_name}" = "clash" ] ; then
    if [ "${iptables}" = "ip6tables -w 100" ] ; then
      ${iptables} -t mangle -A AURORA_EXTERNAL -p udp --dport 53 -j RETURN
      for subnet6 in ${intranet6[@]}; do
        ${iptables} -t mangle -A AURORA_EXTERNAL -d ${subnet6} -j RETURN
      done
    else
      ${iptables} -t mangle -A AURORA_EXTERNAL -p udp --dport 53 -j RETURN
      for subnet in ${intranet[@]} ; do
        ${iptables} -t mangle -A AURORA_EXTERNAL -d ${subnet} -j RETURN
      done
    fi
  else
    if [ "${iptables}" = "ip6tables -w 100" ] ; then
      for subnet6 in ${intranet6[@]} ; do
        ${iptables} -t mangle -A AURORA_EXTERNAL -d ${subnet6} -p udp ! --dport 53 -j RETURN
        ${iptables} -t mangle -A AURORA_EXTERNAL -d ${subnet6} ! -p udp -j RETURN
      done
    else
      for subnet in ${intranet[@]} ; do
        ${iptables} -t mangle -A AURORA_EXTERNAL -d ${subnet} -p udp ! --dport 53 -j RETURN
        ${iptables} -t mangle -A AURORA_EXTERNAL -d ${subnet} ! -p udp -j RETURN
      done
    fi
  fi

  ${iptables} -t mangle -A AURORA_EXTERNAL -p tcp -i lo -j TPROXY --on-port ${tproxy_port} --tproxy-mark 222
  ${iptables} -t mangle -A AURORA_EXTERNAL -p udp -i lo -j TPROXY --on-port ${tproxy_port} --tproxy-mark 222

  if [ "${ap_list}" != "" ] ; then
    for ap in ${ap_list[@]} ; do
      ${iptables} -t mangle -A AURORA_EXTERNAL -p tcp -i ${ap} -j TPROXY --on-port ${tproxy_port} --tproxy-mark 222
      ${iptables} -t mangle -A AURORA_EXTERNAL -p udp -i ${ap} -j TPROXY --on-port ${tproxy_port} --tproxy-mark 222
    done
  fi

  ${iptables} -t mangle -I PREROUTING -j AURORA_EXTERNAL


  ${iptables} -t mangle -N AURORA_LOCAL
  ${iptables} -t mangle -F AURORA_LOCAL

  if [ "${bin_name}" = "clash" ] ; then
    if [ "${iptables}" = "ip6tables -w 100" ] ; then
      ${iptables} -t mangle -A AURORA_LOCAL -p udp --dport 53 -j RETURN
      for subnet6 in ${intranet6[@]} ; do
        ${iptables} -t mangle -A AURORA_LOCAL -d ${subnet6} -j RETURN
      done
    else
      ${iptables} -t mangle -A AURORA_LOCAL -p udp --dport 53 -j RETURN
      for subnet in ${intranet[@]} ; do
        ${iptables} -t mangle -A AURORA_LOCAL -d ${subnet} -j RETURN
      done
    fi
  else
    if [ "${iptables}" = "ip6tables -w 100" ] ; then
      for subnet6 in ${intranet6[@]} ; do
        ${iptables} -t mangle -A AURORA_LOCAL -d ${subnet6} -p udp ! --dport 53 -j RETURN
        ${iptables} -t mangle -A AURORA_LOCAL -d ${subnet6} ! -p udp -j RETURN
      done
    else
      for subnet in ${intranet[@]} ; do
        ${iptables} -t mangle -A AURORA_LOCAL -d ${subnet} -p udp ! --dport 53 -j RETURN
        ${iptables} -t mangle -A AURORA_LOCAL -d ${subnet} ! -p udp -j RETURN
      done
    fi
  fi

  ${iptables} -t mangle -I AURORA_LOCAL -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -j RETURN

  ${iptables} -t mangle -A AURORA_LOCAL -p tcp -j MARK --set-mark 222
  ${iptables} -t mangle -A AURORA_LOCAL -p udp -j MARK --set-mark 222

  ${iptables} -t mangle -I OUTPUT -j AURORA_LOCAL


  ${iptables} -t mangle -N DIVERT
  ${iptables} -t mangle -F DIVERT

  ${iptables} -t mangle -A DIVERT -j MARK --set-mark 222
  ${iptables} -t mangle -A DIVERT -j ACCEPT

  ${iptables} -t mangle -I PREROUTING -p tcp -m socket -j DIVERT

  if [ "${iptables}" = "ip6tables -w 100" ] ; then
    ${iptables} -A OUTPUT -d ::1 -p tcp -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -m tcp --dport ${tproxy_port} -j REJECT
  else
    ${iptables} -A OUTPUT -d 127.0.0.1 -p tcp -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -m tcp --dport ${tproxy_port} -j REJECT
  fi


  if [ "${bin_name}" = "clash" ] && [ "${iptables}" = "iptables -w 100" ] ; then
    ${iptables} -t nat -N DNS_EXTERNAL
    ${iptables} -t nat -F DNS_EXTERNAL

    ${iptables} -t nat -A DNS_EXTERNAL -p udp --dport 53 -j REDIRECT --to-ports ${dns_port}

    ${iptables} -t nat -I PREROUTING -j DNS_EXTERNAL


    ${iptables} -t nat -N DNS_LOCAL
    ${iptables} -t nat -F DNS_LOCAL

    ${iptables} -t nat -A DNS_LOCAL -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -j RETURN

    ${iptables} -t nat -A DNS_LOCAL -p udp --dport 53 -j REDIRECT --to-ports ${dns_port}

    ${iptables} -t nat -I OUTPUT -j DNS_LOCAL

    ${iptables} -t nat -I OUTPUT -d ${fake_ip_range} -p icmp -j DNAT --to-destination 127.0.0.1
    ${iptables} -t nat -I PREROUTING -d ${fake_ip_range} -p icmp -j DNAT --to-destination 127.0.0.1
  fi

}

stop_tproxy() {

  if [ "${iptables}" = "ip6tables -w 100" ] ; then
    ip -6 rule del fwmark 222 table 222
    ip -6 route flush table 222
  else
    ip rule del fwmark 222 table 222
    ip route flush table 222
  fi

  ${iptables} -t mangle -D PREROUTING -j AURORA_EXTERNAL
    
  ${iptables} -t mangle -D PREROUTING -p tcp -m socket -j DIVERT

  ${iptables} -t mangle -D OUTPUT -j AURORA_LOCAL

  ${iptables} -t mangle -F AURORA_EXTERNAL
  ${iptables} -t mangle -X AURORA_EXTERNAL

  ${iptables} -t mangle -F AURORA_LOCAL
  ${iptables} -t mangle -X AURORA_LOCAL

  ${iptables} -t mangle -F DIVERT
  ${iptables} -t mangle -X DIVERT

  if [ "${iptables}" = "ip6tables -w 100" ] ; then
    ${iptables} -D OUTPUT -d ::1 -p tcp -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -m tcp --dport ${tproxy_port} -j REJECT
    ${iptables} -D OUTPUT -d ::1 -p tcp -m owner --uid-owner 0 --gid-owner 3005 -m tcp --dport ${tproxy_port} -j REJECT
  else
    ${iptables} -D OUTPUT -d 127.0.0.1 -p tcp -m owner --uid-owner ${kernel_user} --gid-owner ${kernel_group} -m tcp --dport ${tproxy_port} -j REJECT
    ${iptables} -D OUTPUT -d 127.0.0.1 -p tcp -m owner --uid-owner 0 --gid-owner 3005 -m tcp --dport ${tproxy_port} -j REJECT
  fi

  iptables="iptables -w 100"
  ${iptables} -t nat -D PREROUTING -j DNS_EXTERNAL

  ${iptables} -t nat -D OUTPUT -j DNS_LOCAL

  ${iptables} -t nat -F DNS_EXTERNAL
  ${iptables} -t nat -X DNS_EXTERNAL

  ${iptables} -t nat -F DNS_LOCAL
  ${iptables} -t nat -X DNS_LOCAL

  ${iptables} -t nat -D OUTPUT -d ${fake_ip_range} -p icmp -j DNAT --to-destination 127.0.0.1
  ${iptables} -t nat -D PREROUTING -d ${fake_ip_range} -p icmp -j DNAT --to-destination 127.0.0.1

}

case "$1" in
  a)
    if [ "${iptables_status}" == "Tun" ]; then
      forward I > /dev/null 2>&1
    elif [ "${iptables_status}" = "Mixed" ] ; then
      forward I > /dev/null 2>&1
      iptables="iptables -w 100" && start_redirect > /dev/null 2>&1
    elif [ "${iptables_status}" = "TProxy" ] ; then
      iptables="iptables -w 100" && start_tproxy > /dev/null 2>&1
      if [ "${ipv6}" = "true" ] ; then
        iptables="ip6tables -w 100" && start_tproxy > /dev/null 2>&1
      fi
    fi
    iPV6Network ${ipv6} > /dev/null 2>&1
    notification "iPTables rules loaded"
    ;;
  e)
    if [ "${iptables_status}" == "Tun" ]; then
      forward D > /dev/null 2>&1
    elif [ "${iptables_status}" = "Mixed" ] ; then
      forward I > /dev/null 2>&1
      iptables="iptables -w 100" && stop_redirect > /dev/null 2>&1
    elif [ "${iptables_status}" = "TProxy" ] ; then
      iptables="iptables -w 100" && stop_tproxy > /dev/null 2>&1
      if [ "${ipv6}" = "true" ] ; then
        iptables="ip6tables -w 100" && stop_tproxy > /dev/null 2>&1
      fi
    fi
    iPV6Network true > /dev/null 2>&1
    notification "iPTables rules cleared"
    ;;
  enable)
    ${SPATH}/${BASH} disable && start_bin > /dev/null 2>&1
    if bin_pid=$(pidof ${bin_name} 2>/dev/null) ; then
      ln -sf ${Services} ${DATADIR}/Services.log
      ${SPATH}/${BASH} a && ${SPATH}/${BASH} set
      chattr +i ${SPATH}/${BASH} > /dev/null 2>&1
    else
      notification "Kernel '(${bin_name})' not Started"
      exit 1
    fi
    ;;
  disable)
    if bin_pid=$(pidof ${bin_name} 2>/dev/null) ; then
      ${SPATH}/${BASH} e && kill -15 ${bin_pid}
      rm ${template_file} > /dev/null 2>&1
      rm ${DATADIR}/Kernel.log > /dev/null 2>&1
      rm ${DATADIR}/Services.log > /dev/null 2>&1
      chattr -i ${SPATH}/${BASH} > /dev/null 2>&1
    fi
    ;;
  test)
    echo "BASENAME: ${BASH}" ; echo "ARCH: ${ARCH}" ; echo "SPATH: ${SPATH}" ; echo "iPTables Mode: ${iptables_status}" ; echo "DNS Port: ${dns_port}" ; echo "TProxy Port: ${tproxy_port}" ; echo "Redir Port: ${redir_port}" ; echo "Fake iP Range: ${fake_ip_range}" ; echo "intranet: ${intranet[@]}" ; echo "intranet6: ${intranet6[@]}" ; echo "HOSTNAME: $(getprop net.hostname)" ; echo "Kernel User: ${kernel_user}" ; echo "Kernel Group: ${kernel_group}" ; echo "CPU OCCUPY: $((/system/bin/ps -eo %CPU,NAME | grep ${bin_name} | awk '{print $1"%"}') 2> /dev/null || dumpsys cpuinfo | grep ${bin_name} | awk '{print $1}')" ; echo "${time}"
    ;;
  script)
    script > /dev/null 2>&1
    ;;
  bin)
    ${SPATH}/${BASH} disable
    sleep 2 && ${SPATH}/${BASH} enable
    ;;
  tpre)
    ${SPATH}/${BASH} e
    sleep 2 && ${SPATH}/${BASH} a
    ;;
  dns)
    dns_server $2 > /dev/null 2>&1
    ;;
  nas)
    nas_server $2 > /dev/null 2>&1
    ;;
  ipv6)
    iPV6Network $2 > /dev/null 2>&1
    notification "IP6Table: $2"
    ;;
  updata)
    updata_server > /dev/null 2>&1
    ;;
  upkernel)
    ${SPATH}/${BASH} backup > /dev/null 2>&1
    upkernel > /dev/null 2>&1
    updata_server > /dev/null 2>&1
    rm ${MODPATH}/upkernel
    ;;
  upx)
    chown 0:0 ${SPATH}/upx && chmod 700 ${SPATH}/upx
    chmod 300 ${DATADIR}/$2
    ${SPATH}/upx --best ${DATADIR}/$2
    notification "OCUPX “$2” ${ARCH}"
    ;;
  net)
    if [ "$2" = "false" ]; then
      settings put global airplane_mode_on 1 > /dev/null 2>&1 && am broadcast -a android.intent.action.AIRPLANE_MODE --ez state true > /dev/null 2>&1
    elif [ "$2" = "true" ] ; then
      settings put global airplane_mode_on 0 > /dev/null 2>&1 && am broadcast -a android.intent.action.AIRPLANE_MODE --ez state false > /dev/null 2>&1
    fi
    ;;
  backup)
    if pid=$(pidof ${bin_name} 2>/dev/null); then
      rm -rf ${bakeup_path}
      mkdir -p ${bakeup_path}
      cp ${DATADIR}/*.dat ${bakeup_path}
      cp ${SPATH}/${bin_name} ${bakeup_path}
      cp ${SPATH}/${BASH} ${bakeup_path}/${BASH}.sh
      cp -r ${Dashboard} ${bakeup_path}
      cp -r ${mount_path} ${bakeup_path}
      cp -r ${MODPATH}/config ${bakeup_path}
      cp ${config_path}/${BASH}.ini ${bakeup_path}
    fi
    ;;
  set)
    chown 0:1000 ${config_path}/* && chmod 1770 ${config_path}/*
    chown 0:3005 ${Dashboard}/* && chmod 500 ${Dashboard}/*
    chown 0:3005 ${Dashboard}/*/* && chmod 500 ${Dashboard}/*/*
    chown 0:2 ${config_path}/inotify && chown 0:0 ${config_path}/root
    chmod 7110 ${config_path}/inotify && chmod 440 ${config_path}/root
    ;;
  start)
    echo "${time} - ${BASH} mount path: '${SPATH}' ; ARCH: '${ARCH}'" > ${Services}
    setprop net.hostname "${BASH}" > /dev/null 2>&1 && ${SPATH}/${BASH} set
    nohup inotifyd ${config_path}/inotify ${MODPATH}/ > /dev/null 2>&1 &
    nohup crond -c ${MODPATH}/config > /dev/null 2>&1 &
    dns_server true > /dev/null 2>&1 ; nas_server true > /dev/null 2>&1
    ${SPATH}/${BASH} enable > /dev/null 2>&1
    ;;
  *)
    notification "“$1” No such command, try enter “enable” Start Kernel. | MODE: TProxy · Tun · Mixed · Core"
    exit 1
    ;;
esac