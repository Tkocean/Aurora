#!/sbin/sh

umask 022

ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
. /data/adb/magisk/util_functions.sh
[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

install_module

data_dir="/data/adb/Aurora/"
ca_path="/system/etc/security/cacerts"

mkdir -p ${MODPATH}/system/bin
mkdir -p ${MODPATH}${ca_path}
mkdir -p ${MODPATH}/system/vendor/firmware

unzip -o "${ZIPFILE}" -x 'META-INF/*' -d $MODPATH >&2

mv -f ${MODPATH}/binary/* ${MODPATH}/system/bin/

mkdir ${data_dir}
mkdir ${data_dir}/Kernel
mv ${MODPATH}/Aurora.sh /data/adb/service.d
mv ${MODPATH}/cacert.pem ${MODPATH}${ca_path}
mv ${MODPATH}/wifi.cfg ${MODPATH}/system/vendor/firmware
mv -n ${MODPATH}/Dashboard /data/system/
rm -rf ${MODPATH}/Dashboard
rm -rf ${MODPATH}/binary
set_perm_recursive ${MODPATH} 0 0 0755 0644
set_perm  /data/adb/service.d/Aurora.sh 0  0  7710
set_perm  ${MODPATH}${ca_path}/cacert.pem  0  0  0644
set_perm_recursive ${MODPATH}/config 1000 1000 0700 0700
set_perm_recursive ${MODPATH}/system/bin/Aurora 0 0 7755 7755
set_perm_recursive ${MODPATH}/system/bin/mosdns 0 1051 0750 0750
set_perm_recursive ${MODPATH}/system/bin/upx 0 1000 0750 0750
set_perm_recursive ${MODPATH}/system/bin/Alist 0 1009 7755 7755

exit 0