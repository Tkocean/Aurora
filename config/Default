log:
  level: info
  file: /data/adb/Aurora/run/dns.log

data_providers:

  - tag: geosite
    file: /data/adb/Aurora/GeoSite.dat
    auto_reload: true

  - tag: geoip
    file: /data/adb/Aurora/GeoIP.dat
    auto_reload: true

  - tag: hosts
    file: /data/adb/Aurora/Providers/hosts.txt
    auto_reload: true

plugins:

  - tag: direct
    type: fast_forward
    args:
      upstream:
      - addr: https://120.53.53.53/dns-query
        idle_timeout: 86400
        enable_pipeline: true
        trusted: true
      - addr: https://223.5.5.5/dns-query
        idle_timeout: 86400
        enable_pipeline: true
        trusted: true

  - tag: proxy
    type: fast_forward
    args:
      upstream:
      - addr: https://8.8.4.4/dns-query
        enable_pipeline: true
        enable_http3: false
        trusted: true
      - addr: https://1.0.0.1/dns-query
        enable_pipeline: true
        enable_http3: false
        trusted: true

  - tag: cache
    type: cache
    args:
      size: 65536
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 15
      cache_everything: true

  - tag: ttl
    type: ttl
    args:
      minimal_ttl: 600
      maximum_ttl: 3600

  - tag: hosts
    type: hosts
    args:
      hosts:
      - provider:hosts

  - tag: prevent_type65
    type: query_matcher
    args:
      qtype: [65]

  - tag: proxy_domain
    type: query_matcher
    args:
      domain:
      - provider:geosite:google
      - provider:geosite:geolocation-!cn

  - tag: direct_domain
    type: query_matcher
    args:
      domain:
      - provider:geosite:apple@cn
      - provider:geosite:tencent
      - provider:geosite:cn

  - tag: direct_ip
    type: response_matcher
    args:
      ip:
      - provider:geoip:cn

  - tag: query_is_ad_domain
    type: query_matcher
    args:
      domain:
      - provider:geosite:category-ads-all
      - provider:geosite:win-update
      - provider:geosite:win-spy

  - tag: calculate
    type: sequence
    args:
      exec:
      - hosts
      - _misc_optm
      - _prefer_ipv4
      - cache
      - _pad_query
      - if: direct_domain
        exec:
        - direct
        - _return
        else_exec:
        - if: direct_ip
          exec:
          - direct
          - _return
          else_exec:
          - if: proxy_domain
            exec:
            - proxy
            - _return
            else_exec:
            - primary:
              - proxy
              - _return
              secondary:
              - direct
              - _return
              stat_length: 10
              threshold: 5
      - ttl

  - tag: entrance
    type: sequence
    args:
      exec:
        - if: prevent_type65
          exec:
          - _new_nxdomain_response
          - _return
          else_exec:
            - if: query_is_ad_domain
              exec:
              - _new_nxdomain_response
              - _return
              else_exec:
              - calculate
              - _return

servers:
  - exec: entrance
    listeners:
      - protocol: udp
        addr: 127.0.0.1:2453