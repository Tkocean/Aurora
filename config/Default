log:
  level: info
  file: /data/adb/Aurora/run/dns.log

data_providers:

  - tag: geosite
    file: /data/adb/Aurora/GeoSite.dat
    auto_reload: true

  - tag: geoip
    file: /data/adb/Aurora/GeoIP.dat
    auto_reload: true

plugins:

  - tag: direct
    type: fast_forward
    args:
      upstream:
      - addr: "tls://1.12.12.12:853"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true
      - addr: "tls://223.5.5.5:853"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true
  - tag: proxy
    type: fast_forward
    args:
      upstream:
      - addr: "tls://8.8.8.8:853"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true
      - addr: "tls://1.1.1.1:853"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true

  - tag: prevent_type65
    type: query_matcher
    args:
      qtype: [65]

  - tag: cache
    type: cache
    args:
      size: 65536
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 15
      cache_everything: true

  - tag: ttl
    type: ttl
    args:
      minimal_ttl: 600
      maximum_ttl: 3600

  - tag: direct_domain
    type: query_matcher
    args:
      domain:
      - provider:geosite:apple
      - provider:geosite:cn

  - tag: direct_ip
    type: response_matcher
    args:
      ip:
      - provider:geoip:apple
      - provider:geoip:cn

  - tag: prevent_private
    type: response_matcher
    args:
      ip:
      - provider:geoip:private

  - tag: entrance
    type: sequence
    args:
      exec:
      - if: prevent_private
        exec:
        - _new_nxdomain_response
        - _return
        else_exec:
        - if: prevent_type65
          exec:
          - _new_nxdomain_response
          - _return
          else_exec:
          - _misc_optm
          - _prefer_ipv4
          - cache
          - _pad_query
          - if: direct_domain
            exec:
            - direct
            - _return
            else_exec:
            - if: direct_ip
              exec:
              - direct
              - _return
              else_exec:
              - primary:
                - proxy
                - _return
                secondary:
                - direct
                - _return
                stat_length: 10
                threshold: 5
      - ttl

servers:
  - exec: entrance
    listeners:
      - protocol: udp
        addr: 127.0.0.1:2453