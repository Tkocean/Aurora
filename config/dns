data_providers:

  - tag: geosite
    file: ./GeoSite.dat
    auto_reload: true

  - tag: geoip
    file: ./GeoIP.dat
    auto_reload: true

plugins:

  - tag: entire
    type: fast_forward
    args:
      upstream:
      - addr: "tls://8.8.8.8"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true
      - addr: "tls://1.1.1.1"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true

  - tag: inland
    type: fast_forward
    args:
      upstream:
      - addr: "tls://1.12.12.12"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true
      - addr: "tls://223.5.5.5"
        enable_pipeline: true
        enable_http3: false
        max_conns: 4
        trusted: true

  - tag: cache
    type: cache
    args:
      size: 196608
      lazy_cache_ttl: 172800
      lazy_cache_reply_ttl: 15
      cache_everything: true

  - tag: ttl
    type: ttl
    args:
      minimal_ttl: 600
      maximum_ttl: 3600

  - tag: prevent_domain
    type: query_matcher
    args:
      qtype: [65]
      domain:
      - "provider:geosite:category-ads-all"

  - tag: inland_domain
    type: query_matcher
    args:
      domain:
      - "provider:geosite:apple@cn,cn"

  - tag: inland_response
    type: response_matcher
    args:
      ip:
      - "provider:geoip:apple,cn"

  - tag: entrance
    type: sequence
    args:
      exec:
      - if: prevent_domain
        exec:
        - _new_nxdomain_response
        - _return
        else_exec:
        - _misc_optm
        - _prefer_ipv4
        - _edns0_filter_ecs_only
        - cache
        - _pad_query
        - if: inland_domain
          exec:
          - inland
          - _return
          else_exec:
          - if: inland_response
            exec:
            - inland
            - _return
            else_exec:
            - primary:
              - entire
              - _return
              secondary:
              - inland
              - _return
              stat_length: 10
              threshold: 5
      - ttl

servers:
  - exec: entrance
    listeners:
      - protocol: udp
        addr: localhost:653